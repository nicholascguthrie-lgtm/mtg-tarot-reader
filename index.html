<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"> 
    <title>MTG Tarot Spread Reading</title>
    <style>
        /* General Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        #controls {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Styling for controls */
        #spread-size-selector, #language-selector, #draw-button {
            padding: 10px 15px;
            font-size: 16px;
            margin: 0 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        #draw-button {
            font-weight: bold;
            color: white;
            background-color: #337ab7;
            border: none;
            transition: background-color 0.3s;
        }
        
        #draw-button:hover {
            background-color: #285e8e;
        }
        
        /* CONTAINER RESET */
        #image-gallery {
            display: grid; 
            justify-content: center;
            align-content: center;
            gap: 10px; 
            padding: 20px;
        }

        /* Styling for the container DIV */
        .card-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* Styling for the short label */
        .card-label {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 2px;
            color: #A3333D;
        }
        
        /* Styling for the interpretive description */
        .card-description {
            font-size: 0.9em;
            font-style: italic;
            margin-top: 0;
            margin-bottom: 5px;
            color: #555;
            max-width: 300px;
        }
        
        /* Basic styling for the images */
        .card-slot img {
            width: 300px; 
            height: 420px;
            object-fit: cover; 
            border-radius: 15px; 
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4);
        }
        
        /* === DYNAMIC LAYOUT CLASSES BASED ON SPREAD SIZE === */
        
        /* --- 3-Card Spread (The Triumvirate) --- */
        .spread-layout-3 {
            grid-template-columns: 300px 300px 300px;
            grid-template-rows: 500px;
        }
        .spread-layout-3 .card-slot:nth-child(1) { grid-area: 1 / 1; }
        .spread-layout-3 .card-slot:nth-child(2) { grid-area: 1 / 2; }
        .spread-layout-3 .card-slot:nth-child(3) { grid-area: 1 / 3; }

        /* --- 5-Card Spread (The Cross) --- */
        .spread-layout-5 {
            grid-template-columns: 300px 300px 300px;
            grid-template-rows: 500px 500px 500px;
        }
        .spread-layout-5 .card-slot:nth-child(1) { grid-area: 1 / 2; }
        .spread-layout-5 .card-slot:nth-child(2) { grid-area: 2 / 1; }
        .spread-layout-5 .card-slot:nth-child(3) { grid-area: 2 / 2; }
        .spread-layout-5 .card-slot:nth-child(4) { grid-area: 2 / 3; }
        .spread-layout-5 .card-slot:nth-child(5) { grid-area: 3 / 2; }
        
        /* --- 7-Card Spread (The Progression / Pyramid) --- */
        .spread-layout-7 {
            grid-template-columns: 300px 300px 300px;
            grid-template-rows: 500px 500px 500px;
        }
        .spread-layout-7 .card-slot:nth-child(1) { grid-area: 1 / 1; } 
        .spread-layout-7 .card-slot:nth-child(2) { grid-area: 1 / 2; }
        .spread-layout-7 .card-slot:nth-child(3) { grid-area: 1 / 3; }
        .spread-layout-7 .card-slot:nth-child(4) { grid-area: 2 / 2; } 
        .spread-layout-7 .card-slot:nth-child(5) { grid-area: 3 / 1; }
        .spread-layout-7 .card-slot:nth-child(6) { grid-area: 3 / 2; }
        .spread-layout-7 .card-slot:nth-child(7) { grid-area: 3 / 3; }
        
    </style>
</head>

<body>

    <h1>MTG Variable Spread Reading ðŸ”®</h1>
    
    <div id="controls">
        <label for="language-selector">Language:</label>
        <select id="language-selector">
            <option value="en" selected>English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="ru">Russian</option>
            <option value="zhs">Chinese (Simplified)</option>
            <option value="zht">Chinese (Traditional)</option>
        </select>
        
        <label for="spread-size-selector">Spread Size:</label>
        <select id="spread-size-selector">
            <option value="3">3 Cards - The Triumvirate</option>
            <option value="5" selected>5 Cards - The Cross</option>
            <option value="7">7 Cards - The Progression</option>
        </select>
        
        <button id="draw-button">Draw New Cards</button>
    </div>

    <div id="image-gallery">
        </div>

    <script>
        const BASE_API_URL = 'https://api.scryfall.com/cards/random'; 
        const galleryContainer = document.getElementById('image-gallery');
        const drawButton = document.getElementById('draw-button');
        const sizeSelector = document.getElementById('spread-size-selector');
        const languageSelector = document.getElementById('language-selector');

        const THROTTLE_DELAY_MS = 100;

        const allCardMeanings = {
            3: [
                { shortLabel: "1. The Past", longDescription: "Represents influences, events, or mindsets that have already occurred and shaped the current situation." },
                { shortLabel: "2. The Present", longDescription: "The state of the matter right now. This is the core energy and decision-point you currently face." },
                { shortLabel: "3. The Future", longDescription: "The potential outcome or direction if the present course is maintained. Not fixed, but likely." }
            ],
            5: [
                { shortLabel: "1. The Present", longDescription: "The immediate focus of the reading; what is active and happening right now." },
                { shortLabel: "2. Past Influence", longDescription: "The critical event or action from the recent past that sets the stage for the current core issue." },
                { shortLabel: "3. The Self / Core Issue", longDescription: "The deepest challenge, the underlying truth, or the role the querent (you) plays in the situation." },
                { shortLabel: "4. Future Potential", longDescription: "The likely result of the situation based on current trends and choices." },
                { shortLabel: "5. The Lesson / Outcome", longDescription: "Advice, a warning, or the ultimate wisdom to be gained from the entire spread." }
            ],
            7: [
                { shortLabel: "1. Past Foundation", longDescription: "The history or roots of the matter; how the current circumstances were established." },
                { shortLabel: "2. Hidden Influence", longDescription: "Unseen, internal, or subconscious forces at play that may be blocking a solution." },
                { shortLabel: "3. The Potential", longDescription: "Opportunities or resources that are available to you, but have not yet been used." },
                { shortLabel: "4. The Present Situation", longDescription: "The heart of the reading. What needs to be understood or addressed immediately." },
                { shortLabel: "5. Action/Advice", longDescription: "The recommended course of action, behavior, or attitude to adopt to move forward." },
                { shortLabel: "6. Obstacle/Challenge", longDescription: "An external or obvious difficulty that must be faced or overcome." },
                { shortLabel: "7. The Final Outcome", longDescription: "The projected final state or resolution, provided the suggested actions are followed." }
            ]
        };

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function getCardImageUrl(queryUrl) {
            const response = await fetch(queryUrl);

            if (response.status === 429) {
                throw new Error(`Rate Limit Exceeded (HTTP 429). Please wait a moment before retrying.`);
            }
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            return data.image_uris.normal; 
        }


        async function getMultipleImages() {
            const numberOfCards = parseInt(sizeSelector.value);
            const selectedLanguage = languageSelector.value;
            const currentMeanings = allCardMeanings[numberOfCards];

            const layoutClass = `spread-layout-${numberOfCards}`;

            galleryContainer.className = ''; 
            galleryContainer.classList.add(layoutClass);

            // ------------------------------------------------------------------
            // --- REVERTED FIX: Using the simple, stable language filter ---
            const queryParam = `q=lang:${selectedLanguage}`;
            // ------------------------------------------------------------------
            
            const fullApiUrl = `${BASE_API_URL}?${queryParam}`;

            drawButton.disabled = true;
            galleryContainer.innerHTML = `<p>Fetching ${numberOfCards} new cards in ${selectedLanguage.toUpperCase()}...</p>`;
            
            const imageUrlArray = [];

            try {
                // Throttled loop for fetching card URLs
                for (let i = 0; i < numberOfCards; i++) {
                    const imageUrl = await getCardImageUrl(fullApiUrl);
                    imageUrlArray.push(imageUrl);
                    
                    if (i < numberOfCards - 1) {
                        await delay(THROTTLE_DELAY_MS);
                    }
                }

                galleryContainer.innerHTML = '';

                // Loop through the collected URLs and build the HTML structure
                imageUrlArray.forEach((imageUrl, index) => {
                    
                    const cardData = currentMeanings[index];
                    
                    const cardSlot = document.createElement('div');
                    cardSlot.className = 'card-slot';
                    
                    const label = document.createElement('p');
                    label.className = 'card-label';
                    label.textContent = cardData.shortLabel;
                    
                    const description = document.createElement('p');
                    description.className = 'card-description';
                    description.textContent = cardData.longDescription;
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `MTG Card for position ${cardData.shortLabel}`;

                    cardSlot.appendChild(label);
                    cardSlot.appendChild(description);
                    cardSlot.appendChild(img);
                    
                    galleryContainer.appendChild(cardSlot);
                });

            } catch (error) {
                console.error('There was a problem fetching the MTG cards:', error);
                const displayMessage = error.message.includes('Rate Limit Exceeded')
                    ? 'Rate limit hit. Please wait 10 seconds and try again.'
                    : 'Sorry, could not load the MTG cards. Check your connection or API status.';
                    
                galleryContainer.innerHTML = `<p>${displayMessage}</p>`;
            } finally {
                drawButton.disabled = false;
            }
        }

        // --- Event Listeners ---
        drawButton.addEventListener('click', getMultipleImages);
        sizeSelector.addEventListener('change', getMultipleImages);
        languageSelector.addEventListener('change', getMultipleImages);

        // Initial load
        getMultipleImages(); 
    </script>
</body>
</html>
